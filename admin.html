<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

async function loadStats() {
  try {
    const res = await fetch("/api/chatkit/session");
    const data = await res.json();

    // =========================
    // TOTAL
    // =========================
    document.getElementById("total").innerText = data.stats.total || 0;

    // =========================
    // LEADS PER BRANSCH
    // =========================
    const companyTable = document.getElementById("companyStats");
    companyTable.innerHTML = "";

    if (data.stats.byCompany) {
      for (const company in data.stats.byCompany) {
        companyTable.innerHTML += `
          <tr>
            <td>${company}</td>
            <td>${data.stats.byCompany[company]}</td>
          </tr>
        `;
      }
    }

    // =========================
    // GRAF – LEADS ÖVER TID
    // =========================
    const groupedByDate = {};

    if (data.leads && data.leads.length > 0) {
      data.leads.forEach(lead => {
        const date = new Date(lead.created_at).toLocaleDateString();
        if (!groupedByDate[date]) groupedByDate[date] = 0;
        groupedByDate[date]++;
      });
    }

    const labels = Object.keys(groupedByDate);
    const values = Object.values(groupedByDate);

    const ctx = document.getElementById("leadsChart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Leads",
          data: values,
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59,130,246,0.2)",
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            ticks: { color: "#94a3b8" },
            grid: { color: "#334155" }
          },
          y: {
            ticks: { color: "#94a3b8" },
            grid: { color: "#334155" }
          }
        }
      }
    });

    // =========================
    // SENASTE LEADS
    // =========================
    const leadsTable = document.getElementById("latestLeads");
    leadsTable.innerHTML = "";

    if (data.leads && data.leads.length > 0) {
      data.leads.forEach(lead => {
        leadsTable.innerHTML += `
          <tr>
            <td>${new Date(lead.created_at).toLocaleString()}</td>
            <td>${lead.company || "-"}</td>
            <td>${lead.email || "-"}</td>
            <td>${lead.phone || "-"}</td>
            <td class="message-cell">${lead.message}</td>
          </tr>
        `;
      });
    } else {
      leadsTable.innerHTML = `
        <tr>
          <td colspan="5">Inga leads ännu</td>
        </tr>
      `;
    }

  } catch (error) {
    console.error("Dashboard error:", error);
  }
}

loadStats();
</script>
