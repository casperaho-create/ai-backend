<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  /* =========================
     üîê L√ñSENORD
  ========================= */

  const ADMIN_PASSWORD = "Volvob234!"; // byt

  function protectPage() {
    try {
      const saved = sessionStorage.getItem("admin_auth");

      if (saved === ADMIN_PASSWORD) return true;

      const input = prompt("Ange l√∂senord:");

      if (input === ADMIN_PASSWORD) {
        sessionStorage.setItem("admin_auth", input);
        return true;
      }

      document.body.innerHTML =
        "<div style='display:flex;justify-content:center;align-items:center;height:100vh;background:#0f172a;color:white;font-family:Arial'><h1>‚ùå Fel l√∂senord</h1></div>";
      return false;

    } catch (err) {
      console.error("Password error:", err);
      return false;
    }
  }

  if (!protectPage()) return;

  /* =========================
     üìä DASHBOARD
  ========================= */

  let chart = null;

  async function loadStats() {
    try {
      const res = await fetch("/api/chatkit/session");

      if (!res.ok) {
        console.error("API error:", res.status);
        return;
      }

      const data = await res.json();

      if (!data || !data.stats) {
        console.error("Invalid data:", data);
        return;
      }

      /* TOTAL */
      const totalEl = document.getElementById("total");
      if (totalEl) totalEl.textContent = data.stats.total || 0;

      /* LEADS PER F√ñRETAG */
      const companyTable = document.getElementById("companyStats");
      if (companyTable) {
        companyTable.innerHTML = "";

        const companies = data.stats.byCompany || {};

        Object.keys(companies).forEach(company => {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td>${company}</td>
            <td>${companies[company]}</td>
          `;

          companyTable.appendChild(row);
        });
      }

      /* GRAF */
      const grouped = {};

      (data.leads || []).forEach(lead => {
        if (!lead.created_at) return;
        const date = new Date(lead.created_at).toLocaleDateString();
        grouped[date] = (grouped[date] || 0) + 1;
      });

      const canvas = document.getElementById("leadsChart");

      if (canvas && typeof Chart !== "undefined") {

        const ctx = canvas.getContext("2d");

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: Object.keys(grouped),
            datasets: [{
              data: Object.values(grouped),
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59,130,246,0.2)",
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            plugins: { legend: { display: false } }
          }
        });
      }

      /* SENASTE LEADS */
      const leadsTable = document.getElementById("latestLeads");

      if (leadsTable) {
        leadsTable.innerHTML = "";

        if (data.leads && data.leads.length > 0) {

          data.leads.forEach(lead => {
            const row = document.createElement("tr");

            row.innerHTML = `
              <td>${lead.created_at ? new Date(lead.created_at).toLocaleString() : "-"}</td>
              <td>${lead.company || "-"}</td>
              <td>${lead.email || "-"}</td>
              <td>${lead.phone || "-"}</td>
              <td>${lead.message || "-"}</td>
            `;

            leadsTable.appendChild(row);
          });

        } else {
          leadsTable.innerHTML =
            "<tr><td colspan='5'>Inga leads √§nnu</td></tr>";
        }
      }

    } catch (error) {
      console.error("Dashboard crash:", error);
    }
  }

  /* =========================
     üîÑ AUTO REFRESH
  ========================= */

  loadStats();
  setInterval(loadStats, 30000);

});
</script>
