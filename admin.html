<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>AI Lead Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
}
h1,h2 {
  margin-left:20px;
}
table {
  width:90%;
  margin:20px;
  border-collapse:collapse;
}
td, th {
  padding:10px;
  border-bottom:1px solid #334155;
}
canvas {
  background:white;
  border-radius:8px;
  margin:20px;
  padding:10px;
}
</style>
</head>

<body>

<!-- DASHBOARD (dold tills login) -->
<div id="dashboard" style="display:none; padding-bottom:40px;">

  <h1>ðŸš€ AI Lead Dashboard</h1>

  <h2>Total Leads</h2>
  <div id="total" style="font-size:28px; margin-left:20px;">0</div>

  <h2>Leads per fÃ¶retag</h2>
  <table>
    <tbody id="companyStats"></tbody>
  </table>

  <h2>Leads Ã¶ver tid</h2>
  <canvas id="leadsChart" height="100"></canvas>

  <h2>Senaste Leads</h2>
  <table>
    <tbody id="latestLeads"></tbody>
  </table>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const ADMIN_PASSWORD = "Volvob234!";

  const dashboard = document.getElementById("dashboard");

  /* ======================
     LOGIN UI
  ====================== */

  const loginBox = document.createElement("div");
  loginBox.style = `
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  `;

  loginBox.innerHTML = `
    <div style="background:white;color:black;padding:30px;border-radius:12px;text-align:center;">
      <h2>Admin Login</h2>
      <input type="password" id="adminPass" placeholder="LÃ¶senord"
        style="padding:10px;margin-top:10px;width:200px;">
      <br><br>
      <button id="loginBtn"
        style="padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:6px;">
        Logga in
      </button>
      <p id="errorMsg" style="color:red;margin-top:10px;"></p>
    </div>
  `;

  document.body.appendChild(loginBox);

  function unlock() {
    loginBox.remove();
    dashboard.style.display = "block";
    startDashboard();
  }

  document.getElementById("loginBtn").onclick = function () {
    const value = document.getElementById("adminPass").value;

    if (value === ADMIN_PASSWORD) {
      sessionStorage.setItem("admin_auth", "true");
      unlock();
    } else {
      document.getElementById("errorMsg").innerText = "Fel lÃ¶senord";
    }
  };

  if (sessionStorage.getItem("admin_auth") === "true") {
    unlock();
  }

  /* ======================
     DASHBOARD LOGIK
  ====================== */

  function startDashboard() {

    let chart = null;

    async function loadStats() {
      try {
        const res = await fetch("/api/chatkit/session");
        const data = await res.json();

        if (!data || !data.stats) return;

        document.getElementById("total").textContent = data.stats.total || 0;

        const companyTable = document.getElementById("companyStats");
        companyTable.innerHTML = "";
        const companies = data.stats.byCompany || {};
        Object.keys(companies).forEach(company => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${company}</td>
            <td>${companies[company]}</td>
          `;
          companyTable.appendChild(row);
        });

        const grouped = {};
        (data.leads || []).forEach(lead => {
          if (!lead.created_at) return;
          const date = new Date(lead.created_at).toLocaleDateString();
          grouped[date] = (grouped[date] || 0) + 1;
        });

        const canvas = document.getElementById("leadsChart");

        if (canvas && typeof Chart !== "undefined") {
          const ctx = canvas.getContext("2d");
          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: Object.keys(grouped),
              datasets: [{
                data: Object.values(grouped),
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59,130,246,0.2)",
                tension: 0.3,
                fill: true
              }]
            },
            options: { plugins: { legend: { display: false } } }
          });
        }

        const leadsTable = document.getElementById("latestLeads");
        leadsTable.innerHTML = "";

        if (data.leads && data.leads.length > 0) {
          data.leads.forEach(lead => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${new Date(lead.created_at).toLocaleString()}</td>
              <td>${lead.company || "-"}</td>
              <td>${lead.email || "-"}</td>
              <td>${lead.phone || "-"}</td>
              <td>${lead.message || "-"}</td>
            `;
            leadsTable.appendChild(row);
          });
        } else {
          leadsTable.innerHTML =
            "<tr><td colspan='5'>Inga leads Ã¤nnu</td></tr>";
        }

      } catch (err) {
        console.error("Dashboard error:", err);
      }
    }

    loadStats();
    setInterval(loadStats, 30000);
  }

});
</script>

</body>
</html>
