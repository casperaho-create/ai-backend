<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* =========================
   üîê L√ñSENORDSSKYDD
========================= */

const ADMIN_PASSWORD = "Volvob234!"; // <-- BYT DENNA!

function checkPassword() {
  const saved = sessionStorage.getItem("admin_auth");

  if (saved === ADMIN_PASSWORD) {
    loadStats();
    startAutoRefresh();
    return;
  }

  const input = prompt("Ange l√∂senord f√∂r adminpanelen:");

  if (input === ADMIN_PASSWORD) {
    sessionStorage.setItem("admin_auth", input);
    loadStats();
    startAutoRefresh();
  } else {
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#0f172a;color:white;font-family:Arial">
        <h1>‚ùå Fel l√∂senord</h1>
      </div>
    `;
  }
}

/* =========================
   üìä DASHBOARD LOGIK
========================= */

let chart;
let refreshInterval;

async function loadStats() {
  try {
    const res = await fetch("/api/chatkit/session");
    const data = await res.json();

    if (!data || !data.stats) return;

    /* TOTAL */
    const totalEl = document.getElementById("total");
    if (totalEl) totalEl.innerText = data.stats.total || 0;

    /* LEADS PER F√ñRETAG */
    const companyTable = document.getElementById("companyStats");
    if (companyTable) {
      companyTable.innerHTML = "";
      if (data.stats.byCompany) {
        for (const company in data.stats.byCompany) {
          companyTable.innerHTML += `
            <tr>
              <td>${company}</td>
              <td>${data.stats.byCompany[company]}</td>
            </tr>
          `;
        }
      }
    }

    /* GRAF ‚Äì LEADS √ñVER TID */
    const groupedByDate = {};

    if (data.leads && data.leads.length > 0) {
      data.leads.forEach(lead => {
        const date = new Date(lead.created_at).toLocaleDateString();
        if (!groupedByDate[date]) groupedByDate[date] = 0;
        groupedByDate[date]++;
      });
    }

    const labels = Object.keys(groupedByDate);
    const values = Object.values(groupedByDate);

    const canvas = document.getElementById("leadsChart");

    if (canvas) {
      const ctx = canvas.getContext("2d");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Leads",
            data: values,
            borderColor: "#3b82f6",
            backgroundColor: "rgba(59,130,246,0.2)",
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: "#94a3b8" },
              grid: { color: "#334155" }
            },
            y: {
              ticks: { color: "#94a3b8" },
              grid: { color: "#334155" }
            }
          }
        }
      });
    }

    /* SENASTE LEADS */
    const leadsTable = document.getElementById("latestLeads");

    if (leadsTable) {
      leadsTable.innerHTML = "";

      if (data.leads && data.leads.length > 0) {
        data.leads.forEach(lead => {
          leadsTable.innerHTML += `
            <tr>
              <td>${new Date(lead.created_at).toLocaleString()}</td>
              <td>${lead.company || "-"}</td>
              <td>${lead.email || "-"}</td>
              <td>${lead.phone || "-"}</td>
              <td>${lead.message || "-"}</td>
            </tr>
          `;
        });
      } else {
        leadsTable.innerHTML = `
          <tr>
            <td colspan="5">Inga leads √§nnu</td>
          </tr>
        `;
      }
    }

  } catch (error) {
    console.error("Dashboard error:", error);
  }
}

/* =========================
   üîÑ AUTO REFRESH
========================= */

function startAutoRefresh() {
  refreshInterval = setInterval(() => {
    loadStats();
  }, 30000); // 30 sekunder
}

/* =========================
   üöÄ STARTA
========================= */

checkPassword();
</script>
